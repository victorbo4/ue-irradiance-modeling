@startuml irradiancesubsys
title
Figura B.1.4 – Diagrama de la clase UIrradianceSubsystem
end title
' === CONFIGURACIÓN ===
skinparam classAttributeIconSize 0  

skinparam linetype ortho            
skinparam shadowing false           
skinparam monochrome true           
skinparam packageStyle rectangle 

left to right direction        

' === CLASES ===
class FCaptureRequest <<struct>> {
   //(Ver definición detallada en//
     //el Anexo B.1.3: Planificador de capturas)//
}

class FExportOptions <<struct>> {
    + bExportCSV : bool
    + bExportImages : bool
    + OutputDir : FDirectoryPath
    + ImagesSubdir : FString
    + CSVFilename : FString
}

class UIrradianceExporter {
  
}

class UClearSkyService {
   
}

enum ECaptureState {
    Idle
    Capturing
    WaitingReadback
}

' === ESTRUCTURA INTERNA (Detallada porque vive aquí) ===

class FCaptureContext <<struct>> {
    ' == Datos ==
    + Request : FCaptureRequest
    + FaceIndex : int32
    + FacesCollected : int32
    + FixedFaceRots : TArray<FQuat>
    + FaceRTs : TStaticArray<TRefCountPtr<IPooledRenderTarget>, 6>
    + ExtractedIrradianceBuffer : TRefCountPtr<FRDGPooledBuffer>
    + IrradianceReadback : TUniquePtr<FRHIGPUBufferReadback>
    + bReadbackEnqueued : bool

    ' == Métodos ==
    + Begin(InRequest : FCaptureRequest) : void
    + Reset() : void
    + IsValid() : bool
    + GetPosWS() : FVector
    + IsLastFace() : bool
    + AdvanceFace() : void
    + StoreFaceRT(InRT : TRefCountPtr<IPooledRenderTarget>&&) : void
    + ArmFace(VE : FIrradianceViewExtension*) : void
    + HasActiveReadback() : bool
}

' === CLASE PRINCIPAL ===

class UIrradianceSubsystem {
    ' == Estado Interno ==
    - Capture : FCaptureContext
    - State : ECaptureState
    - ViewExt : TSharedPtr<FIrradianceViewExtension>
    - bIrradianceValueReady : std::atomic<bool>
    - LastIrradianceMean : std::atomic<float>
   
    ' == Viewport & Exportación ==
    - bForcedRes : bool
    - PrevPIEWindow : TWeakPtr<SWindow>
    - Exporter : TObjectPtr<UIrradianceExporter>
    - bIsHijacked : bool
    - CaptureCam : TWeakObjectPtr<ACameraActor>
    - ClearSky : TObjectPtr<UClearSkyService>

    ' == API Pública ==
    + Initialize(Collection : FSubsystemCollectionBase&) : void
    + StartSixFaceCapture(Req : FCaptureRequest) : void
    + ConfigureExport(bCSV : bool, bExportImages : bool, Path : FString) : void
    + ConsumeLatestIrradiance(OutValue : float&, MinAlt : float) : bool
    + FlushExporter() : void
    + ForceSquareViewportPIE(SidePx : int32) : bool
    + ComputeSkyViewFactor(Req : FCaptureRequest, Samples : int32) : float
    + GetClearSky() : UClearSkyService*

    ' == Métodos Privados (Lógica Core) ==
    - TickCapturing() : void
    - TickReadback() : void
    - EnqueueReadbackCopy() : void
    - EnqueueReadbackPolling() : void
    - EnsureCaptureCamera() : void
    - StartFaceCapture(PosWS : FVector, RotWS : FQuat) : void
    - ComputeFinalIrradiance() : void
    - ComputeSunOcclusion(Req : FCaptureRequest, ...) : bool
    - ComputeSunVisibility(Req : FCaptureRequest, Samples : int32) : float
}

' === RELACIONES ===

' El Subsistema contiene fuertemente (Composición) al Contexto y Opciones
UIrradianceSubsystem *-- "1" FCaptureContext 
UIrradianceSubsystem *-- "1" FExportOptions

' El Contexto guarda la Request original
FCaptureContext *-- "1" FCaptureRequest : almacena >

' Referencias a otros sistemas (Agregación)
UIrradianceSubsystem o-- "0..1" UIrradianceExporter
UIrradianceSubsystem o-- "0..1" UClearSkyService

@enduml